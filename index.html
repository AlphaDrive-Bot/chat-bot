<script>
async function startRecording() {
  const responseDiv = document.getElementById('response');
  responseDiv.innerHTML += "<p>🎙 מתחיל להקליט...</p>";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = function (e) {
      chunks.push(e.data);
    };

    mediaRecorder.onstop = async function () {
      const blob = new Blob(chunks, { type: 'audio/webm' });
      const formData = new FormData();
      formData.append('file', blob, 'voice.webm');
      formData.append('message_type', 'voice');

      try {
        const res = await fetch("https://chaim.app.n8n.cloud/webhook/d-id-agent", {
          method: "POST",
          body: formData
        });

        const raw = await res.text();
        let parsed = null;
        try {
          parsed = JSON.parse(raw);
        } catch (_) {
          parsed = { text: raw };
        }

        if (parsed.text) {
          const botMsg = document.createElement("div");
          botMsg.className = "bubble bot-bubble fade-in";
          botMsg.innerHTML = parsed.text;
          responseDiv.appendChild(botMsg);
        }

        if (parsed.audio_url) {
          const audio = new Audio(parsed.audio_url);
          audio.play();
        }

        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

      } catch (err) {
        responseDiv.innerHTML += `<p>❌ שגיאה בשליחה: ${err.message}</p>`;
      }
    };

    mediaRecorder.start();

    setTimeout(() => {
      mediaRecorder.stop();
      stream.getTracks().forEach(track => track.stop());
    }, 4000); // הקלטה של 4 שניות
  } catch (err) {
    responseDiv.innerHTML += `<p>❌ שגיאת הקלטה: ${err.message}</p>`;
  }
}
</script>
