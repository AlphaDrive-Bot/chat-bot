<script>
  let mediaRecorder;
  let stream;
  let chunks = [];

  const micButton = document.querySelector(".mic-button");
  const responseDiv = document.getElementById('response');

  function showRecordingIndicator() {
    const indicator = document.getElementById("global-rec-indicator");
    if (indicator) indicator.style.display = "flex";
  }

  function hideRecordingIndicator() {
    const indicator = document.getElementById("global-rec-indicator");
    if (indicator) indicator.style.display = "none";
  }

  async function startRecording() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/ogg' });
      chunks = [];

      mediaRecorder.ondataavailable = function (e) {
        chunks.push(e.data);
      };

      mediaRecorder.onstop = async function () {
        hideRecordingIndicator();

        const blob = new Blob(chunks, { type: 'audio/ogg' });
        const file = new File([blob], 'voice.ogg', { type: 'audio/ogg' });

        const formData = new FormData();
        formData.append('file', file);
        formData.append('message_type', 'voice');
        formData.append('source', 'mic');

        const thinking = document.createElement("div");
        thinking.id = "thinking";
        thinking.innerHTML = `â³ ×”×¡×•×›×Ÿ ×—×•×©×‘...
          <div class="wave"><span></span><span></span><span></span><span></span><span></span></div>`;
        responseDiv.appendChild(thinking);
        scrollToBottom();

        try {
          const res = await fetch("https://chaim.app.n8n.cloud/webhook/d-id-agent", {
            method: "POST",
            body: formData
          });

          const raw = await res.text();
          let parsed = null;
          try {
            parsed = JSON.parse(raw);
          } catch (_) {
            parsed = { text: raw };
          }

          thinking.remove();
          if (parsed.text) {
            const botMsg = document.createElement("div");
            botMsg.className = "bubble bot-bubble fade-in";
            botMsg.innerHTML = linkify(parsed.text);
            responseDiv.appendChild(botMsg);
          }

          if (parsed.audio_url) {
            new Audio(parsed.audio_url).play();
          }

          scrollToBottom();
          stream.getTracks().forEach(track => track.stop());

        } catch (err) {
          thinking.remove();
          responseDiv.innerHTML += `<p>âŒ ×©×’×™××” ×‘×©×œ×™×—×”: ${err.message}</p>`;
        }
      };

      mediaRecorder.start();
      showRecordingIndicator();

    } catch (err) {
      responseDiv.innerHTML += `<p>âŒ ×©×’×™××” ×‘×”×§×œ×˜×”: ${err.message}</p>`;
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
  }

  micButton.addEventListener("mousedown", startRecording);
  micButton.addEventListener("mouseup", stopRecording);
  micButton.addEventListener("touchstart", startRecording);
  micButton.addEventListener("touchend", stopRecording);

  function linkify(text) {
    return text.replace(/(https?:\/\/[^\s]+)/g, url => {
      return `<a href="${url}" target="_blank">ğŸ”— ×œ×—×¥ ×›××Ÿ</a>`;
    });
  }

  function scrollToBottom() {
    const anchor = document.getElementById("scroll-anchor");
    if (!anchor) return;

    setTimeout(() => {
      anchor.scrollIntoView({
        behavior: "smooth",
        block: "end"
      });
    }, 100);
  }

  async function sendToBot(text = null) {
    const inputEl = document.getElementById('userInput');
    const input = text || inputEl.value.trim();
    if (!input) return;

    const userMsg = document.createElement("div");
    userMsg.className = "bubble user-bubble fade-in";
    userMsg.innerText = input;
    responseDiv.appendChild(userMsg);

    const thinking = document.createElement("div");
    thinking.id = "thinking";
    thinking.innerHTML = `â³ ×”×¡×•×›×Ÿ ×—×•×©×‘...
      <div class="wave"><span></span><span></span><span></span><span></span><span></span></div>`;
    responseDiv.appendChild(thinking);
    scrollToBottom();

    inputEl.value = "";

    try {
      const res = await fetch("https://chaim.app.n8n.cloud/webhook/d-id-agent", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: input })
      });

      const raw = await res.text();
      let parsed = null;
      try {
        parsed = JSON.parse(raw.trim());
      } catch (_) {
        parsed = { text: raw };
      }

      thinking.remove();
      if (parsed.text) {
        const botMsg = document.createElement("div");
        botMsg.className = "bubble bot-bubble fade-in";
        botMsg.innerHTML = linkify(parsed.text);
        responseDiv.appendChild(botMsg);
      }

      if (parsed.audio_url) {
        const audio = new Audio(parsed.audio_url);
        audio.play();
      }

      scrollToBottom();

    } catch (err) {
      thinking.remove();
      responseDiv.innerHTML += `<p>âŒ ×©×’×™××” ×‘×©×œ×™×—×”: ${err.message}</p>`;
    }
  }

  document.getElementById('userInput').addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      sendToBot();
    }
  });
</script>
